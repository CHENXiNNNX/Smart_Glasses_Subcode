#### 整体图像采集目标:
采用RKMPI框架的自动通道绑定机制，实现VI→ISP→VENC的视频处理流水线

### 系统架构图
```
+-------------+      +-------------+      +-------------+      +-------------+      +-------------+
|             |      |             |      |             |      |             |      |             |  
|   相机硬件   |----->|    VI设备    |----->|   ISP处理   |----->|  VENC编码器  |----->|  输出处理模块 |
|             |      |             |      |             |      |             |      |             |
+-------------+      +-------------+      +-------------+      +-------------+      +-------------+
        |                    |                    |                    |
        |                    |                    |                    |
        v                    v                    v                    v
+---------------------------------------------------------------------------+
|                                                                           |
|                        视频系统管理 (video_system_t)                       |
|                                                                           |
+---------------------------------------------------------------------------+
                       |             |             |
                       v             v             v
              +-------------+ +-------------+ +-------------+
              |             | |             | |             |
              |  模式管理   | |  视频流处理  | |   工具函数   |
              |             | |             | |             |
              +-------------+ +-------------+ +-------------+
```


### 数据流向说明
1. 相机硬件采集原始图像数据
2. 通过RKMPI的VI设备获取图像数据
3. 图像数据通过ISP进行图像处理(包括去噪、色彩校正、曝光控制等)
4. VI与VENC通道绑定，处理后的数据自动传输到VENC进行编码
5. 编码后的数据可用于多种输出：本地存储(拍照/录像)、RTSP推流等
6. 整个过程由video_system_t结构体统一管理，实现模式切换、状态监控等功能

### 设计原则
- **以性能为核心**：所有设计都围绕性能优化，充分利用硬件特性（如RKMPI的通道绑定），减少软件开销
- **以实时为目标**：适合实时视频处理，低延迟设计，高吞吐量保证
- **减少内存拷贝**：尽量以零拷贝和双缓冲机制为目标，实现良好的内存管理以及帧处理机制

## 1. 图像采集模式设计

### 1.1 模式枚举定义
```c
typedef enum {
    VIDEO_MODE_NONE = 0,      // 空模式
    VIDEO_MODE_PHOTO,         // 拍照模式
    VIDEO_MODE_RECORD,        // 录像模式
    VIDEO_MODE_RTSP,          // RTSP推流模式
    VIDEO_MODE_WEBRTC         // WebRTC推流模式(预留空实现)
} video_mode_t;
```

### 1.2 模式功能说明
- **空模式(VIDEO_MODE_NONE)**：系统空闲状态
- **拍照模式(VIDEO_MODE_PHOTO)**：支持JPEG格式拍照，连续采集5帧，保存最后一帧
- **录像模式(VIDEO_MODE_RECORD)**：支持H264格式录像，可手动开始/停止
- **RTSP推流模式(VIDEO_MODE_RTSP)**：支持H264格式网络推流，可手动开始/停止
- **WebRTC推流模式(VIDEO_MODE_WEBRTC)**：预留接口，暂未实现

### 1.3 模式控制方式
所有模式都采用**手动控制**方式，确保用户精确控制：

```c
// 拍照模式控制
take_picture(sys);  // 触发拍照，采集5帧保存最后一帧

// 录像模式控制
start_record(sys);  // 开始录像
stop_record(sys);   // 停止录像

// RTSP推流模式控制
start_rtsp_stream(sys);  // 开始RTSP推流
stop_rtsp_stream(sys);   // 停止RTSP推流
```

## 2. 编码格式支持

### 2.1 支持的编码格式
```c
typedef enum {
    ENCODE_FORMAT_JPEG = 0,   // JPEG格式
    ENCODE_FORMAT_H264,       // H264格式
    ENCODE_FORMAT_H265        // H265格式(预留)
} encode_format_t;
```

### 2.2 格式应用场景
- **JPEG**：用于拍照模式，单帧图像存储
- **H264**：用于录像模式和RTSP推流，视频流处理
- **H265**：预留接口，未来扩展使用

## 3. 核心数据结构设计

### 3.1 视频系统结构体
```c
typedef struct {
    // 基本参数
    int width;                    // 图像宽度
    int height;                   // 图像高度
    video_mode_t current_mode;    // 当前模式
    encode_format_t encode_format; // 编码格式
    
    // RKMPI资源
    VENC_STREAM_S stFrame;        // 编码流结构体
    
    // 协议资源
    #if USE_RTSP
    rtsp_demo_handle rtsp_handle;     // RTSP演示句柄
    rtsp_session_handle rtsp_session; // RTSP会话句柄
    bool is_rtsp_streaming;           // 是否正在RTSP推流
    #endif
    
    // 状态管理
    bool is_initialized;          // 初始化状态
    bool is_streaming;            // 流状态
    bool quit_flag;               // 退出标志
    float current_fps;            // 当前帧率
    
    // 线程资源
    pthread_t stream_thread;      // 流处理线程
    
    // 拍照配置
    int current_picture_id;       // 当前照片ID
    int photo_capture_count;      // 拍照采集计数
    int photo_capture_total;      // 采集帧数，只取最后一帧
    bool photo_capturing;         // 是否正在拍照采集
    
    // 录像配置
    int current_record_id;        // 当前录像ID
    bool is_recording;            // 是否正在录像
    FILE *record_file;            // 录像文件句柄
    char record_filename[256];    // 录像文件名
    
    // 编码参数
    int bitrate;                  // 码率
    int gop;                      // GOP大小
    int quality;                  // 质量参数
} video_system_t;
```

## 4. 错误处理机制

### 4.1 错误类型枚举
```c
typedef enum {
    VIDEO_ERROR_NONE = 0,      // 无错误
    VIDEO_ERROR_INVALID_PARAM, // 无效参数
    VIDEO_ERROR_ALLOC_MEM,     // 内存分配失败
    VIDEO_ERROR_INIT,          // 初始化失败
    VIDEO_ERROR_RUNNING,       // 运行中错误
    VIDEO_ERROR_UNKNOWN        // 未知错误
} video_error_t;
```

### 4.2 错误处理策略
- 统一错误码管理
- 完善的参数验证
- 资源清理机制
- 详细的错误日志输出

## 5. 接口函数设计

### 5.1 统一时间管理
```c
// 获取精准时间戳(微秒级)
RK_U64 get_nowus(void);
```

### 5.2 视频系统管理
```c
// 初始化函数
int isp_init(void);                    // 初始化ISP
int vi_dev_init(void);                 // 初始化VI设备
int vi_chn_init(int channelId, int width, int height); // 初始化VI通道
int venc_init(int chnId, int width, int height, RK_CODEC_ID_E enType); // 初始化编码器
int init_video_system(video_system_t **sys, int width, int height, video_mode_t mode); // 初始化视频系统
int release_video_system(video_system_t **sys); // 释放视频系统
```

### 5.3 视频流管理
```c
// 流控制
int start_video_stream(video_system_t *sys);  // 开始视频流
int stop_video_stream(video_system_t *sys);   // 停止视频流

// 编码流处理
int get_encoded_stream(video_system_t *sys, VENC_STREAM_S *stFrame, int timeout_ms); // 获取编码流
int release_encoded_stream(video_system_t *sys, VENC_STREAM_S *stFrame); // 释放编码流
```

### 5.4 编码器管理
```c
// 编码参数设置
int set_encoding_params(video_system_t *sys, encode_format_t format, int bitrate, int gop, int quality);
int set_video_quality(video_system_t *sys, int bitrate, int gop);
```

### 5.5 功能管理
```c
// 拍照功能
int take_picture(video_system_t *sys);  // 拍照(采集5帧，保存最后一帧)

// 录像功能
int start_record(video_system_t *sys);  // 开始录像
int stop_record(video_system_t *sys);   // 停止录像

// 文件存储
int save_to_path(const char *path, const void *data, size_t size); // 通用文件存储函数
```

### 5.6 推流管理
```c
// RTSP推流
int start_rtsp_stream(video_system_t *sys);  // 开始RTSP推流
int stop_rtsp_stream(video_system_t *sys);   // 停止RTSP推流

// WebRTC推流(预留)
int webrtc_stream(video_system_t *sys);      // WebRTC推流(预留空实现)
```

### 5.7 工具函数管理
```c
// 模式管理
video_mode_t get_video_mode(video_system_t *sys);  // 获取当前视频模式
int set_video_mode(video_system_t *sys, video_mode_t mode); // 设置视频模式

// 状态监控
float get_current_fps(video_system_t *sys);  // 获取当前FPS
bool is_system_ready(video_system_t *sys);   // 检查系统是否就绪
```

## 6. 存储路径配置

### 6.1 路径定义
```c
#define PICTURE_PATH "/root/picture/"  // 照片存储路径
#define RECORD_PATH "/root/video/"     // 录像存储路径
```

### 6.2 文件命名规则
- **照片文件**：`photo_0.jpg`, `photo_1.jpg`, ...
- **录像文件**：`record_0.h264`, `record_1.h264`, ...

## 7. 使用流程示例

### 7.1 基本使用流程
```c
// 1. 初始化系统
video_system_t *sys;
init_video_system(&sys, 1920, 1080, VIDEO_MODE_RTSP);
start_video_stream(sys);

// 2. 控制RTSP推流
start_rtsp_stream(sys);  // 开始推流
// ... 运行一段时间 ...
stop_rtsp_stream(sys);   // 停止推流

// 3. 切换到拍照模式
set_video_mode(sys, VIDEO_MODE_PHOTO);
take_picture(sys);  // 拍照

// 4. 切换到录像模式
set_video_mode(sys, VIDEO_MODE_RECORD);
start_record(sys);  // 开始录像
// ... 录像一段时间 ...
stop_record(sys);   // 停止录像

// 5. 释放系统
release_video_system(&sys);
```

### 7.2 性能优化特性
- **零拷贝设计**：使用DMABUF内存类型，减少内存拷贝
- **双缓冲机制**：提高帧处理效率
- **硬件加速**：充分利用RKMPI硬件编码能力
- **实时处理**：低延迟、高吞吐量的视频处理

## 8. 技术特点总结

### 8.1 架构优势
- **模块化设计**：清晰的模块分离，易于维护
- **统一控制**：三种模式使用一致的控制方式
- **状态管理**：完善的状态监控和控制
- **错误处理**：统一的错误处理机制

### 8.2 性能优势
- **硬件加速**：充分利用RKMPI硬件特性
- **内存优化**：零拷贝和双缓冲机制
- **实时处理**：适合智能眼镜等实时应用场景

### 8.3 扩展性
- **协议支持**：支持RTSP、WebRTC等多种推流协议
- **格式支持**：支持JPEG、H264、H265等多种编码格式
- **模式扩展**：易于添加新的工作模式